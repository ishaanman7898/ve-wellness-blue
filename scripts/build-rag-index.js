/**
 * Build RAG index for Cloudflare Worker from knowledge base
 * Pure JavaScript - no Python needed!
 */
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

function chunkText(text, maxChars = 800) {
  if (text.length <= maxChars) {
    return [text];
  }
  
  const chunks = [];
  const paragraphs = text.split('\n\n');
  let currentChunk = "";
  
  for (const para of paragraphs) {
    if (currentChunk.length + para.length + 2 <= maxChars) {
      currentChunk += para + "\n\n";
    } else {
      if (currentChunk) {
        chunks.push(currentChunk.trim());
      }
      currentChunk = para + "\n\n";
    }
  }
  
  if (currentChunk) {
    chunks.push(currentChunk.trim());
  }
  
  return chunks;
}

function buildRagIndex() {
  console.log('ðŸš€ Building RAG index for Cloudflare Worker...\n');
  
  // Load knowledge base
  const knowledgePath = path.join(__dirname, '../public/knowledge_base.json');
  
  if (!fs.existsSync(knowledgePath)) {
    console.error('âŒ knowledge_base.json not found!');
    console.log('   Run: npm run build:knowledge first');
    process.exit(1);
  }
  
  const knowledge = JSON.parse(fs.readFileSync(knowledgePath, 'utf-8'));
  
  const ragChunks = [];
  const siteUrl = process.env.PUBLIC_SITE_URL || 'http://localhost:8080';
  
  for (const entry of knowledge) {
    const title = entry.title || 'Thrive Wellness';
    const content = entry.content || '';
    
    // Determine URL based on title
    let url = `${siteUrl}/`;
    const titleLower = title.toLowerCase();
    
    if (titleLower.includes('product') || titleLower.includes('bundle')) {
      url = `${siteUrl}/shop`;
    } else if (titleLower.includes('team') || titleLower.includes('leadership')) {
      url = `${siteUrl}/team`;
    } else if (titleLower.includes('contact')) {
      url = `${siteUrl}/contact`;
    } else if (titleLower.includes('shipping')) {
      url = `${siteUrl}/shipping`;
    } else if (titleLower.includes('faq')) {
      url = `${siteUrl}/faq`;
    } else if (titleLower.includes('company') || titleLower.includes('mission')) {
      url = `${siteUrl}/about`;
    }
    
    // Split content into chunks
    const textChunks = chunkText(content);
    
    for (let i = 0; i < textChunks.length; i++) {
      const chunkTitle = textChunks.length === 1 ? title : `${title} (Part ${i + 1})`;
      ragChunks.push({
        title: chunkTitle,
        url: url,
        content: textChunks[i].trim(),
        embedding: []  // Embeddings will be generated by Cloudflare Worker
      });
    }
  }
  
  // Build index
  const ragIndex = {
    chunks: ragChunks
  };
  
  // Save to public folder for Cloudflare Pages
  const outputPath = path.join(__dirname, '../public/rag_index.json');
  fs.writeFileSync(outputPath, JSON.stringify(ragIndex, null, 2), 'utf-8');
  
  console.log(`âœ… RAG index built successfully!`);
  console.log(`   Total chunks: ${ragChunks.length}`);
  console.log(`   Output: ${outputPath}`);
  console.log(`\nðŸš€ Ready for Cloudflare Pages deployment!`);
}

buildRagIndex();
